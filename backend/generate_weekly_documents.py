#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
每周文档生成脚本
自动生成Excel（本周行情数据）和TXT（每周周报）文档
"""

import openpyxl
from openpyxl.styles import Font, Alignment
from datetime import datetime, timedelta
import os

def get_week_range():
    """获取本周的起止日期（周一到周日）"""
    today = datetime.now()
    # 获取本周周一
    monday = today - timedelta(days=today.weekday())
    # 获取本周周日
    sunday = monday + timedelta(days=6)
    return monday, sunday

def generate_excel_document():
    """生成Excel文档 - 本周行情数据"""
    # 创建工作簿
    wb = openpyxl.Workbook()
    sheet = wb.active
    sheet.title = "重点省份行情"

    # 定义省份列表
    provinces = ["全国", "河北", "山东", "河南", "湖北", "四川", "黑龙江", "陕西", "甘肃", "广西", "广东", "江西", "福建"]

    # 模拟本周数据 - 生猪、仔猪、鸡蛋
    data_table1 = [
        ["地区", "生猪(元/kg)", "仔猪(元/kg)", "鸡蛋(元/kg)"],
        ["全国", "12.50(+0.08)", "20.36(+0.13)", "7.04(-0.27)"],
        ["河北", "12.17(-0.34)", "19.85(+0.25)", "6.85(-0.45)"],
        ["山东", "12.49(-0.14)", "20.45(+0.18)", "7.02(-0.28)"],
        ["河南", "12.42(-0.10)", "20.10(+0.12)", "6.98(-0.32)"],
        ["湖北", "12.55(+0.10)", "20.74(+0.51)", "7.15(-0.18)"],
        ["四川", "12.80(+0.00)", "21.05(+0.00)", "7.25(-0.15)"],
        ["黑龙江", "11.95(-0.23)", "19.50(+0.30)", "7.00(+0.00)"],
        ["陕西", "12.30(-0.15)", "20.20(+0.15)", "6.95(-0.38)"],
        ["甘肃", "12.10(-0.28)", "19.95(+0.22)", "6.88(-0.42)"],
        ["广西", "12.90(+0.05)", "20.90(+0.08)", "7.18(-0.20)"],
        ["广东", "13.10(+0.08)", "21.20(-0.05)", "7.35(-0.08)"],
        ["江西", "12.65(-0.07)", "20.65(+0.10)", "7.10(-0.25)"],
        ["福建", "12.85(+0.12)", "20.85(+0.17)", "7.20(-0.12)"],
    ]

    # 模拟本周数据 - 淘汰鸡、玉米、豆粕
    data_table2 = [
        ["地区", "淘汰鸡(元/kg)", "玉米(元/吨)", "豆粕(元/吨)"],
        ["全国", "10.52(-0.45)", "2319(-5)", "3245(-15)"],
        ["河北", "10.15(-0.55)", "2295(-10)", "3220(-18)"],
        ["山东", "10.45(-0.48)", "2315(+0)", "3240(-12)"],
        ["河南", "10.38(-0.52)", "2308(-8)", "3235(-14)"],
        ["湖北", "10.68(-0.35)", "2335(-3)", "3260(-10)"],
        ["四川", "10.85(-0.28)", "2350(+5)", "3275(-8)"],
        ["黑龙江", "10.25(-0.42)", "2280(-12)", "3205(-22)"],
        ["陕西", "10.30(-0.50)", "2305(-7)", "3230(-16)"],
        ["甘肃", "10.18(-0.58)", "2290(-15)", "3215(-20)"],
        ["广西", "10.75(-0.32)", "2340(+2)", "3265(-9)"],
        ["广东", "10.95(-0.18)", "2360(+8)", "3285(-5)"],
        ["江西", "10.62(-0.40)", "2330(-4)", "3255(-11)"],
        ["福建", "10.80(-0.25)", "2345(+3)", "3270(-7)"],
    ]

    # 写入第一个表格
    for row_idx, row_data in enumerate(data_table1, start=1):
        for col_idx, value in enumerate(row_data, start=1):
            cell = sheet.cell(row=row_idx, column=col_idx, value=value)
            cell.font = Font(name="Calibri", size=12)
            cell.alignment = Alignment(horizontal="left", vertical="center")

    # 写入第二个表格
    row_start_table2 = len(data_table1) + 2
    for row_idx, row_data in enumerate(data_table2, start=row_start_table2):
        for col_idx, value in enumerate(row_data, start=1):
            cell = sheet.cell(row=row_idx, column=col_idx, value=value)
            cell.font = Font(name="Calibri", size=12)
            cell.alignment = Alignment(horizontal="left", vertical="center")

    # 设置列宽
    sheet.column_dimensions['A'].width = 12
    sheet.column_dimensions['B'].width = 18
    sheet.column_dimensions['C'].width = 18
    sheet.column_dimensions['D'].width = 18

    # 保存文件
    monday, sunday = get_week_range()
    week_str = monday.strftime("%Y-%m-%d") + "至" + sunday.strftime("%Y-%m-%d")
    filename = f"本周行情数据_{week_str}.xlsx"
    wb.save(filename)
    print(f"✅ Excel文档已生成: {filename}")
    return filename

def generate_txt_document():
    """生成TXT文档 - 每周周报"""
    monday, sunday = get_week_range()
    week_str = monday.strftime("%Y年%m月%d日") + "至" + sunday.strftime("%m月%d日")
    filename = f"每周周报_{monday.strftime('%Y-%m-%d')}至{sunday.strftime('%Y-%m-%d')}.txt"

    content = f"""
========================================
        安佑预混料市场周报
========================================

报告周期：{week_str}
发布时间：{datetime.now().strftime("%Y年%m月%d日 %H:%M")}
编制单位：安佑心科技

========================================
一、本周行情总览
========================================

1. 生猪市场
   全国均价：12.50元/kg（+0.08，环比上涨）
   本周生猪价格整体呈现震荡上行趋势。受节日备货需求增加及养殖户惜售心理影响，市场供应略有收紧，价格小幅上涨。其中河北、山东等主产区价格下跌，湖北、四川等地价格稳定，广东、广西等销区价格坚挺。

2. 仔猪市场
   全国均价：20.36元/kg（+0.13，环比上涨）
   仔猪价格延续上涨态势。随着春季补栏需求增加，养殖户对后市预期转好，仔猪交易活跃度提升。各地价格普遍上涨，其中湖北涨幅最大，达到+0.51元/kg。

3. 鸡蛋市场
   全国均价：7.04元/kg（-0.27，环比下跌）
   鸡蛋价格全面回落。供应端存栏量维持高位，鸡蛋产量充足，叠加消费淡季影响，市场供大于求，价格持续下跌。河北、河南等地跌幅较大。

4. 淘汰鸡市场
   全国均价：10.52元/kg（-0.45，环比下跌）
   淘汰鸡价格承压下行。随着蛋鸡养殖亏损加剧，养殖户集中淘汰老鸡，市场供应增加，价格持续下跌。甘肃、河北等地跌幅明显。

5. 玉米市场
   全国均价：2319元/吨（-5，环比下跌）
   玉米价格整体走弱。基层售粮进度加快，市场供应充裕，叠加下游饲料企业采购节奏放缓，价格小幅下跌。黑龙江、河北等地跌幅较大，广东、四川等地逆势上涨。

6. 豆粕市场
   全国均价：3245元/吨（-15，环比下跌）
   豆粕价格持续下跌。国际大豆价格下行，成本支撑减弱，叠加国内油厂开工率回升，豆粕供应增加，价格承压下行。黑龙江、甘肃等地跌幅超过20元/吨。

========================================
二、下周市场预测
========================================

1. 生猪市场：预计稳中有涨。节日需求持续释放，养殖户惜售情绪不减，价格有望延续上行态势。建议关注生猪出栏进度及政策动向。

2. 仔猪市场：预计小幅上涨。补栏需求维持旺盛，价格支撑较强，但上涨空间有限，需警惕二次育肥风险。

3. 鸡蛋市场：预计震荡偏弱。短期供应充裕格局难改，价格或继续探底，但随着节日需求临近，跌势有望放缓。

4. 淘汰鸡市场：预计继续下跌。集中淘汰高峰仍将持续，供应压力较大，价格下行趋势未改。

5. 玉米市场：预计弱势震荡。基层售粮压力仍在，价格难有起色，但底部支撑较强，深跌空间有限。

6. 豆粕市场：预计低位盘整。国际市场仍将影响国内价格，供需宽松格局下，价格或维持低位运行。

========================================
三、重点关注
========================================

1. 关注政策动向：近期生猪价格回升，需密切关注储备肉投放政策及环保政策变化。

2. 关注天气因素：春季气候多变，需防范极端天气对养殖、运输环节的影响。

3. 关注疫情动态：非洲猪瘟、禽流感等疫情动态需持续关注，防范疫情对市场的冲击。

========================================
四、数据来源及免责声明
========================================

本报告数据来源于安佑心科技市场监测系统及行业公开数据，仅供参考，不构成投资建议。市场有风险，投资需谨慎。

联系方式：安佑心科技
更新时间：每日上午9:00

========================================
"""

    with open(filename, 'w', encoding='utf-8') as f:
        f.write(content.strip())

    print(f"✅ TXT文档已生成: {filename}")
    return filename

def main():
    """主函数 - 生成所有文档"""
    print("=" * 60)
    print("每周文档自动生成系统")
    print("=" * 60)
    print(f"执行时间: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print()

    try:
        # 生成Excel文档
        excel_filename = generate_excel_document()
        print()

        # 生成TXT文档
        txt_filename = generate_txt_document()
        print()

        print("=" * 60)
        print("✅ 所有文档生成完成！")
        print(f"   - Excel: {excel_filename}")
        print(f"   - TXT:   {txt_filename}")
        print("=" * 60)

    except Exception as e:
        print(f"❌ 文档生成失败: {str(e)}")
        raise

if __name__ == "__main__":
    main()
