# 每周日自动生成周报功能说明

## 功能概述

系统现在支持**每周日中午12:00**自动生成周报，包括：

### 自动化任务

1. **每天上午9:00**：自动采集最新价格数据（生猪、仔猪、鸡蛋、淘汰鸡、玉米、豆粕）
2. **每周日12:00**：自动生成周报Excel和TXT文档

### 周报内容

#### Excel文档（本周行情数据.xlsx）
- 两个表格，Calibri 12pt字体
- 表格1：全国及12个省份的生猪、仔猪、鸡蛋周均价
- 表格2：全国及12个省份的淘汰鸡、玉米、豆粕周均价
- 每个价格都显示与上周的涨跌情况

#### TXT文档（每周周报.txt）
- 本周行情总览
- 各品类市场分析
- 下周市场预测
- 数据来源及免责声明

### 下载方式

在"我的"页面，有两个下载按钮：
1. **下载 Excel**：下载本周行情数据Excel文件
2. **下载 周报**：下载每周周报TXT文件

## 工作原理

### 数据流程

```
每天9:00
  ↓
data_collector.py 采集数据
  ↓
保存到 market_data.json（最新数据）
  ↓
追加到 market_history.json（历史数据）
  ↓

每周日12:00
  ↓
weekly_report_generator.py 读取历史数据
  ↓
计算本周周均价（周一到周日）
  ↓
计算与上周的涨跌
  ↓
生成 Excel 和 TXT 文档
  ↓
更新 weekly_report_index.json（索引文件）
  ↓

用户访问"我的"页面
  ↓
从 GitHub 读取 weekly_report_index.json
  ↓
获取最新周报文件名
  ↓
点击下载按钮，从 GitHub 下载文件
```

### 文件说明

#### 后端文件

1. **market_data.json** - 每天的最新数据
   ```json
   {
     "timestamp": "2026-01-20T09:00:00",
     "date": "2026-01-20",
     "products": {
       "生猪": {"price": 12.73, "sources": [...]},
       "仔猪": {"price": 19.72, "sources": [...]},
       ...
     }
   }
   ```

2. **market_history.json** - 历史数据（最近60天）
   ```json
   {
     "2026-01-20": {
       "date": "2026-01-20",
       "products": {...}
     },
     "2026-01-19": {...},
     ...
   }
   ```

3. **weekly_report_index.json** - 周报索引
   ```json
   {
     "latest": {
       "week_start": "2026-01-20",
       "week_end": "2026-01-26",
       "excel": "本周行情数据_2026-01-20至2026-01-26.xlsx",
       "txt": "每周周报_2026-01-20至2026-01-26.txt",
       "generated_at": "2026-01-26T12:00:00"
     },
     "history": [...]
   }
   ```

#### 生成的周报文件

- **本周行情数据_YYYY-MM-DD至YYYY-MM-DD.xlsx** - Excel格式
- **每周周报_YYYY-MM-DD至YYYY-MM-DD.txt** - TXT格式

## 配置说明

### GitHub Actions 配置

#### 每日数据采集（daily-data-collection.yml）
```yaml
schedule:
  - cron: '0 1 * * *'  # 每天北京时间9:00（UTC时间1:00）
```

#### 每周周报生成（weekly-report.yml）
```yaml
schedule:
  - cron: '0 4 * * 0'  # 每周周日北京时间12:00（UTC时间4:00）
```

### 前端配置

在两个HTML文件中，都需要修改GitHub用户名：

1. **netlify-deploy/index.html**（第646行）
2. **netlify-deploy/profile.html**（第418行）

修改：
```javascript
const GITHUB_USERNAME = 'YOUR_GITHUB_USERNAME';
```

改为你的GitHub用户名，例如：
```javascript
const GITHUB_USERNAME = 'zhangsan';
```

## 使用方法

### 自动运行

配置完成后，系统会自动：
1. 每天上午9:00采集数据
2. 每周日12:00生成周报
3. 前端页面自动显示最新数据
4. "我的"页面提供下载按钮

### 手动触发周报生成

如果需要立即生成周报（不等到周日）：

1. 访问GitHub仓库
2. 点击 "Actions" 标签
3. 选择 "Weekly Report Generation"
4. 点击 "Run workflow" 按钮
5. 等待1-2分钟，周报文件会生成

### 手动下载周报

1. 访问你的网站
2. 点击底部导航的 "我的"
3. 点击 "下载 Excel" 或 "下载 周报" 按钮
4. 文件会自动下载到你的电脑

## 数据说明

### 周均价计算

周均价 = 本周（周一到周日）所有日期的平均值

例如，本周生猪价格：
- 周一：12.70元/kg
- 周二：12.75元/kg
- 周三：12.73元/kg
- 周四：12.80元/kg
- 周五：12.78元/kg
- 周六：12.76元/kg
- 周日：12.74元/kg

周均价 = (12.70 + 12.75 + 12.73 + 12.80 + 12.78 + 12.76 + 12.74) / 7 = 12.75元/kg

### 涨跌计算

与上周的对比：
- 涨跌幅 = 本周周均价 - 上周周均价
- 涨跌百分比 = (本周周均价 - 上周周均价) / 上周周均价 × 100%

### 省份数据

当前系统只采集全国均价，各省份数据基于全国均价模拟生成（±5%波动）。

如果后续需要真实省份数据，需要：
1. 修改 data_collector.py，采集各省份数据
2. 修改 weekly_report_generator.py，使用真实省份数据
3. 更新前端显示逻辑

## 常见问题

### Q1: 周日没有自动生成周报？

**A:**
1. 检查GitHub Actions是否正常运行
2. 访问仓库 → Actions → Weekly Report Generation
3. 查看运行日志，检查是否有错误
4. 常见原因：依赖安装失败、历史数据不足

### Q2: 周报文件下载失败？

**A:**
1. 检查profile.html中的GITHUB_USERNAME是否正确
2. 检查weekly_report_index.json文件是否存在
3. 检查Excel和TXT文件是否在backend/目录下
4. 检查浏览器控制台是否有错误信息

### Q3: 周报数据不准确？

**A:**
当前系统：
- ✅ 全国均价：真实采集
- ⚠️  省份数据：模拟生成（基于全国均价±5%波动）

如果需要真实省份数据，需要配置真实的数据源API。

### Q4: 如何修改生成时间？

**A:**
编辑 `.github/workflows/weekly-report.yml`：

```yaml
schedule:
  - cron: '0 4 * * 0'  # 改为你需要的时间
```

cron格式：`分 时 日 月 周`

### Q5: 历史数据保留多久？

**A:**
- market_history.json 保留最近60天的数据
- weekly_report_index.json 保留最近10周的周报索引

你可以修改代码中的这些参数。

## 总结

✅ **完全自动化**：每天采集数据，每周日生成周报
✅ **一键下载**：在"我的"页面点击下载按钮即可
✅ **完全免费**：GitHub Actions + Netlify免费版
✅ **数据完整**：6大品类，全国均价，涨跌对比
✅ **格式规范**：Excel（两个表格，Calibri 12pt）+ TXT

---

**祝你使用愉快！** 🎉
